<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TCG Card Manager - Unified Workflow</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="js/navbar.js"></script>
    <script src="js/errorHandler.js"></script>
    <style>
        /* Card Search & Display Styles */
        .card-image {
            width: 100%;
            height: auto;
            cursor: pointer;
        }
        .card-container {
            margin-bottom: 20px;
        }
        #loading {
            display: none;
        }
        #error-message {
            display: none;
        }
        .selected-card {
            border: 3px solid #007bff;
            background-color: #e6f2ff;
        }
        .card-list-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
            transition: background-color 0.2s;
            cursor: pointer;
        }
        .card-list-item:hover {
            background-color: #f0f7ff;
        }
        .card-thumbnail {
            width: 60px;
            height: 84px;
            object-fit: cover;
            margin-right: 15px;
        }
        .card-info {
            flex-grow: 1;
        }
        .card-actions {
            min-width: 100px;
            text-align: right;
        }
        .search-and-details-row {
            height: 500px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        .search-results-container {
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 0.25rem;
        }
        #card-details-container {
            height: 450px;
            overflow-y: auto;
            margin-bottom: 1rem;
        }
        #search-results {
            overflow-y: auto;
            max-height: 350px;
            flex: 1;
        }
        .price-info {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
        }
        .price-info h5 {
            margin-bottom: 10px;
            color: #0d6efd;
        }
        .price-info table {
            width: 100%;
        }
        .price-info td {
            padding: 3px 0;
        }
        .price-info td:first-child {
            font-weight: bold;
            width: 60%;
        }
        .price-info td:last-child {
            text-align: right;
        }
        .price-info .estimated-price {
            font-size: 1.1em;
            font-weight: bold;
            color: #198754;
        }
        
        /* Pricing Tool Styles */
        .card-pricing {
            font-size: 0.9rem;
        }
        .price-changed {
            background-color: #e8f4f8;
        }
        .table-container {
            max-height: 600px;
            overflow-y: auto;
        }
        .stats-card {
            border-left: 4px solid #0d6efd;
        }
        .sortable {
            cursor: pointer;
            position: relative;
            user-select: none;
        }
        .sortable:hover {
            background-color: #e9ecef;
        }
        .sort-icon::after {
            content: "⇵";
            opacity: 0.3;
            margin-left: 5px;
            font-size: 0.8em;
        }
        .sort-asc .sort-icon::after {
            content: "↑";
            opacity: 1;
        }
        .sort-desc .sort-icon::after {
            content: "↓";
            opacity: 1;
        }
        .active-sort {
            background-color: #e9ecef;
        }
        .quantity-input {
            width: 70px;
            min-width: 60px;
            padding: 2px 5px;
            text-align: center;
        }
        
        /* Unified Interface Styles */
        .workflow-step {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .workflow-step h3 {
            margin-bottom: 10px;
            font-weight: 600;
        }
        .workflow-step p {
            margin-bottom: 15px;
            opacity: 0.9;
        }
        .step-number {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-weight: bold;
        }
        .nav-tabs .nav-link {
            border: none;
            border-bottom: 3px solid transparent;
            color: #6c757d;
            font-weight: 500;
        }
        .nav-tabs .nav-link.active {
            border-bottom-color: #0d6efd;
            color: #0d6efd;
            background: none;
        }
        .tab-content {
            padding: 20px 0;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-ready {
            background-color: #198754;
        }
        .status-loading {
            background-color: #ffc107;
        }
        .status-error {
            background-color: #dc3545;
        }
        .price-list-status {
            font-size: 0.9em;
            margin-top: 5px;
        }
        .price-list-loaded {
            color: #198754;
        }
        .price-list-error {
            color: #dc3545;
        }
        .price-list-loading {
            color: #0d6efd;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container-fluid mt-4">
        <!-- Header with Workflow Overview -->
        <div class="workflow-step">
            <h3><span class="step-number">1</span>TCG Card Manager - Unified Workflow</h3>
            <p>Import your inventory, update prices, and manage your TCG card collection all in one place.</p>
            <div class="row">
                <div class="col-md-3">
                    <div class="d-flex align-items-center">
                        <span class="status-indicator status-ready"></span>
                        <span>Import Current Inventory</span>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="d-flex align-items-center">
                        <span class="status-indicator status-ready"></span>
                        <span>Import Price List</span>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="d-flex align-items-center">
                        <span class="status-indicator status-ready"></span>
                        <span>Add/Update Cards</span>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="d-flex align-items-center">
                        <span class="status-indicator status-ready"></span>
                        <span>Calculate & Export</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Import Section -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">Step 1: Import Current Inventory</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="inventory-csv-file" class="form-label">Select Inventory CSV File</label>
                            <input class="form-control" type="file" id="inventory-csv-file" accept=".csv">
                        </div>
                        <div class="mb-3">
                            <button id="import-inventory-btn" class="btn btn-success">Import Inventory</button>
                        </div>
                        <div id="inventory-import-status" class="alert alert-info d-none"></div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Step 2: Import Price List</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <div id="price-list-status" class="price-list-status me-2">Loading price list...</div>
                        </div>
                        <div class="mb-3">
                            <button id="update-price-list" class="btn btn-primary">Update Price List</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <ul class="nav nav-tabs" id="mainTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="search-tab" data-bs-toggle="tab" data-bs-target="#search-panel" type="button" role="tab">
                    <i class="fas fa-search"></i> Card Search & Add
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="pricing-tab" data-bs-toggle="tab" data-bs-target="#pricing-panel" type="button" role="tab">
                    <i class="fas fa-dollar-sign"></i> Pricing Tool
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="mainTabContent">
            <!-- Card Search & Add Panel -->
            <div class="tab-pane fade show active" id="search-panel" role="tabpanel">

                <div class="row search-and-details-row">
                    <!-- Left Column: Card Search (60%) -->
                    <div class="col-md-7">
                        <div class="card h-100">
                            <div class="card-header">
                                <h3>Card Search</h3>
                            </div>
                            <div class="card-body" style="overflow: hidden; display: flex; flex-direction: column; height: 430px;">
                                <div class="input-group mb-3">
                                    <input type="text" id="search-input" class="form-control" placeholder="Enter card name...">
                                    <button id="search-button" class="btn btn-primary">Search</button>
                                </div>
                                
                                <div id="loading" class="text-center">
                                    <div class="spinner-border" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mt-2">Searching for cards...</p>
                                </div>
                                
                                <div id="error-message" class="alert alert-danger"></div>
                                
                                <div id="search-results" class="search-results-container">
                                    <p class="text-center p-3">Enter a card name to search</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Right Column: Card Details (40%) -->
                    <div class="col-md-5">
                        <div class="card h-100">
                            <div class="card-header bg-primary text-white">
                                <h3>Card Details</h3>
                            </div>
                            <div class="card-body" id="card-details-container">
                                <p class="text-center">Select a card to view details</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Inventory Section -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">My Inventory</h5>
                                <button id="export-csv" class="btn btn-success btn-sm">Export to CSV</button>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-container" style="max-height: 300px; overflow-y: auto;">
                                    <table class="table table-striped table-hover mb-0">
                                        <thead class="sticky-top bg-light">
                                            <tr>
                                                <th>Card Name</th>
                                                <th>Set</th>
                                                <th>Condition</th>
                                                <th>Quantity</th>
                                                <th>Price</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="inventory-body">
                                            <tr>
                                                <td colspan="6" class="text-center">No cards in inventory</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>



            <!-- Pricing Tool Panel -->
            <div class="tab-pane fade" id="pricing-panel" role="tabpanel">
                <div class="row mb-4">
                    <div class="col-md-12">
                        <div class="card stats-card">
                            <div class="card-header">
                                <h5 class="mb-0">Inventory Statistics</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label class="form-label">Total Cards</label>
                                            <h3 id="total-cards">0</h3>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label class="form-label">Total Value</label>
                                            <h3 id="total-value">$0.00</h3>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label class="form-label">Average Price</label>
                                            <h3 id="avg-price">$0.00</h3>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label class="form-label">Actions</label>
                                            <div class="d-grid gap-2">
                                                <button id="calculate-btn" class="btn btn-success btn-sm">Calculate Prices</button>
                                                <button id="export-btn" class="btn btn-secondary btn-sm">Export Updated CSV</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">Card Inventory</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-container">
                            <table class="table table-striped table-hover mb-0">
                                <thead class="sticky-top bg-light">
                                    <tr>
                                        <th class="sortable" data-sort="name">Card Name <span class="sort-icon"></span></th>
                                        <th class="sortable" data-sort="set">Set <span class="sort-icon"></span></th>
                                        <th class="sortable" data-sort="condition">Condition <span class="sort-icon"></span></th>
                                        <th class="sortable" data-sort="quantity">Qty <span class="sort-icon"></span></th>
                                        <th class="sortable" data-sort="marketPrice">Market Price <span class="sort-icon"></span></th>
                                        <th class="sortable" data-sort="lowPrice">Low Price <span class="sort-icon"></span></th>
                                        <th class="sortable" data-sort="lowShipping">Low w/ Shipping <span class="sort-icon"></span></th>
                                        <th class="sortable" data-sort="originalPrice">Original Price <span class="sort-icon"></span></th>
                                        <th class="sortable" data-sort="calculatedPrice">Calculated Price <span class="sort-icon"></span></th>
                                    </tr>
                                </thead>
                                <tbody id="card-table-body">
                                    <tr>
                                        <td colspan="9" class="text-center">Import a CSV file to view cards</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">Pricing Rules</h5>
                    </div>
                    <div class="card-body">
                        <ul>
                            <li><strong>Minimum Price:</strong> No card can be priced less than $0.50</li>
                            <li><strong>Standard Cards ($0.30 - $30):</strong> max($0.50, max(TCG Low Price, average of TCG Low With Shipping and TCG Market Price))</li>
                            <li><strong>Cheap Cards (≤ $0.30):</strong> max($0.50, TCG Low Price)</li>
                            <li><strong>Expensive Cards (> $30):</strong> Keep original price</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/api.js"></script>
    <script src="js/inventory.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/app.js"></script>
    <script src="js/tcgPricing.js"></script>
    <script>
        // Global variables
        let priceList = [];
        let selectedCard = null;
        let inventory = [];

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize the card search functionality
            App.init();
            
            // Initialize pricing service for the pricing tool
            const pricingService = new TCGPricingService();
            window.pricingService = pricingService;
            
            // Initialize UI elements
            initializeUI();
            initializeEventListeners();
            loadSavedData();
        });

        function initializeUI() {
            // Initialize Bootstrap tabs
            const triggerTabList = [].slice.call(document.querySelectorAll('#mainTabs button'))
            triggerTabList.forEach(function (triggerEl) {
                const tabTrigger = new bootstrap.Tab(triggerEl)
                triggerEl.addEventListener('click', function (event) {
                    event.preventDefault()
                    tabTrigger.show()
                })
            });
        }

        function initializeEventListeners() {
            // Inventory import button
            document.getElementById('import-inventory-btn').addEventListener('click', function() {
                const fileInput = document.getElementById('inventory-csv-file');
                const file = fileInput.files[0];
                
                if (!file) {
                    showInventoryImportStatus('Please select a CSV file first.', 'danger');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const csvText = e.target.result;
                        importInventoryFromCSV(csvText);
                        showInventoryImportStatus('Inventory imported successfully!', 'success');
                    } catch (error) {
                        showInventoryImportStatus(`Error importing inventory: ${error.message}`, 'danger');
                        console.error('Inventory import error:', error);
                    }
                };
                
                reader.onerror = function() {
                    showInventoryImportStatus('Error reading file', 'danger');
                };
                
                reader.readAsText(file);
            });

            // Price list update button
            document.getElementById('update-price-list').addEventListener('click', function() {
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = '.csv';
                
                fileInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    const fileSizeMB = file.size / (1024 * 1024);
                    if (fileSizeMB > 50) {
                        if (!confirm(`File size is ${fileSizeMB.toFixed(1)}MB. Large files may take a while to process and could cause browser issues. Continue?`)) {
                            return;
                        }
                    }
                    
                    const priceListStatus = document.getElementById('price-list-status');
                    priceListStatus.textContent = `Processing ${fileSizeMB.toFixed(1)}MB file...`;
                    priceListStatus.className = 'price-list-status price-list-loading';
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const csvText = e.target.result;
                            setTimeout(() => {
                                processLargeCSV(csvText, fileSizeMB);
                            }, 100);
                        } catch (error) {
                            priceListStatus.textContent = `Error: ${error.message}`;
                            priceListStatus.className = 'price-list-status price-list-error';
                            console.error('Error reading price list:', error);
                        }
                    };
                    
                    reader.onerror = function() {
                        priceListStatus.textContent = 'Error reading file';
                        priceListStatus.className = 'price-list-status price-list-error';
                    };
                    
                    reader.readAsText(file);
                });
                
                fileInput.click();
            });

            // Pricing tool event listeners
            const calculateBtn = document.getElementById('calculate-btn');
            const exportBtn = document.getElementById('export-btn');
            const cardTableBody = document.getElementById('card-table-body');
            const totalCardsElement = document.getElementById('total-cards');
            const totalValueElement = document.getElementById('total-value');
            const avgPriceElement = document.getElementById('avg-price');
            
            // Sorting state
            let currentSort = {
                column: 'name',
                direction: 'asc'
            };
            
            // Add event listeners to sortable headers
            document.querySelectorAll('th.sortable').forEach(header => {
                header.addEventListener('click', function() {
                    const column = this.dataset.sort;
                    
                    if (currentSort.column === column) {
                        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                    } else {
                        currentSort.column = column;
                        currentSort.direction = 'asc';
                    }
                    
                    document.querySelectorAll('th.sortable').forEach(th => {
                        th.classList.remove('sort-asc', 'sort-desc', 'active-sort');
                    });
                    
                    this.classList.add('active-sort');
                    this.classList.add(currentSort.direction === 'asc' ? 'sort-asc' : 'sort-desc');
                    
                    if (pricingService.cards.length > 0) {
                        updateCardTable(sortCards(pricingService.cards));
                    }
                });
            });

            

            // Calculate button
            calculateBtn.addEventListener('click', function() {
                try {
                    // Recalculate prices for all inventory items
                    inventory.forEach(item => {
                        item.calculatePrice();
                    });
                    
                    updatePricingTable();
                    updatePricingStatistics();
                    showPricingStatus('Prices calculated successfully!', 'success');
                    exportBtn.disabled = false;
                } catch (error) {
                    showPricingStatus(`Error calculating prices: ${error.message}`, 'danger');
                    console.error('Calculation error:', error);
                }
            });

            // Export button
            exportBtn.addEventListener('click', function() {
                try {
                    const csvContent = exportInventoryToCSV();
                    downloadCSV(csvContent, 'updated_inventory.csv');
                    showPricingStatus('CSV exported successfully!', 'success');
                } catch (error) {
                    showPricingStatus(`Error exporting CSV: ${error.message}`, 'danger');
                    console.error('Export error:', error);
                }
            });
        }

        function processLargeCSV(csvText, fileSizeMB) {
            const lines = csvText.split('\n');
            const totalLines = lines.length;
            const headers = parseCSVLine(lines[0]);
            
            priceList = [];
            let processedLines = 0;
            const chunkSize = 1000;
            
            function processChunk() {
                const startIndex = processedLines + 1;
                const endIndex = Math.min(startIndex + chunkSize, totalLines);
                
                for (let i = startIndex; i < endIndex; i++) {
                    if (!lines[i].trim()) continue;
                    
                    try {
                        const values = parseCSVLine(lines[i]);
                        if (values.length !== headers.length) continue;
                        
                        const card = {
                            tcgplayerId: values[0].replace(/"/g, ''),
                            productLine: values[1].replace(/"/g, ''),
                            setName: values[2].replace(/"/g, ''),
                            productName: values[3].replace(/"/g, ''),
                            title: values[4].replace(/"/g, ''),
                            number: values[5].replace(/"/g, ''),
                            rarity: values[6].replace(/"/g, ''),
                            condition: values[7].replace(/"/g, ''),
                            tcgMarketPrice: parseFloat(values[8]) || 0,
                            tcgDirectLow: values[9].replace(/"/g, ''),
                            tcgLowWithShipping: parseFloat(values[10]) || 0,
                            tcgLowPrice: parseFloat(values[11]) || 0,
                            totalQuantity: values[12].replace(/"/g, ''),
                            addToQuantity: values[13].replace(/"/g, ''),
                            tcgMarketplacePrice: values[14].replace(/"/g, ''),
                            photoUrl: values[15].replace(/"/g, ''),
                            
                            calculatePrice: function() {
                                const marketPrice = this.tcgMarketPrice;
                                const lowPrice = this.tcgLowPrice;
                                const lowWithShipping = this.tcgLowWithShipping;
                                
                                let estimatedPrice;
                                
                                if (marketPrice <= 0.30) {
                                    estimatedPrice = Math.max(0.50, lowPrice);
                                } else if (marketPrice > 30) {
                                    estimatedPrice = marketPrice;
                                } else {
                                    const avgLowAndMarket = (lowWithShipping + marketPrice) / 2;
                                    estimatedPrice = Math.max(0.50, Math.max(lowPrice, avgLowAndMarket));
                                }
                                
                                this.estimatedPrice = estimatedPrice;
                                return estimatedPrice;
                            }
                        };
                        
                        priceList.push(card);
                    } catch (error) {
                        console.warn(`Error processing line ${i}:`, error);
                    }
                }
                
                processedLines = endIndex - 1;
                const progress = ((processedLines / (totalLines - 1)) * 100).toFixed(1);
                
                const priceListStatus = document.getElementById('price-list-status');
                priceListStatus.textContent = `Processing: ${progress}% (${processedLines.toLocaleString()} of ${(totalLines - 1).toLocaleString()} cards)`;
                
                if (processedLines < totalLines - 1) {
                    setTimeout(processChunk, 10);
                } else {
                    priceListStatus.textContent = `Price list updated: ${priceList.length.toLocaleString()} cards`;
                    priceListStatus.className = 'price-list-status price-list-loaded';
                    console.log(`Updated price list with ${priceList.length} cards`);
                    
                    if (selectedCard) {
                        displayCardDetails(selectedCard);
                    }
                    
                    try {
                        const sampleData = priceList.slice(0, 1000);
                        localStorage.setItem('priceListSample', JSON.stringify(sampleData));
                        localStorage.setItem('priceListCount', priceList.length.toString());
                    } catch (storageError) {
                        console.warn('Could not save price list sample to localStorage:', storageError.message);
                    }
                }
            }
            
            processChunk();
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    if (inQuotes && line[i + 1] === '"') {
                        current += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current);
            return result;
        }

        function loadSavedData() {
            try {
                const savedPriceList = localStorage.getItem('priceListSample');
                const savedCount = localStorage.getItem('priceListCount');
                
                if (savedPriceList && savedCount) {
                    priceList = JSON.parse(savedPriceList);
                    const priceListStatus = document.getElementById('price-list-status');
                    priceListStatus.textContent = `Price list loaded: ${savedCount} cards (sample)`;
                    priceListStatus.className = 'price-list-status price-list-loaded';
                }
                
                // Load saved inventory
                const savedInventory = localStorage.getItem('inventory');
                if (savedInventory) {
                    inventory = JSON.parse(savedInventory);
                    updateInventoryTable();
                    updatePricingTable();
                    updatePricingStatistics();
                    console.log(`Loaded ${inventory.length} inventory items from localStorage`);
                }
            } catch (error) {
                console.warn('Error loading saved data:', error);
            }
        }

        function updateCardTable(cards) {
            const tbody = document.getElementById('card-table-body');
            tbody.innerHTML = '';
            
            if (cards.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center">No cards to display</td></tr>';
                return;
            }
            
            cards.forEach(card => {
                const row = document.createElement('tr');
                if (card.priceChanged) {
                    row.classList.add('price-changed');
                }
                
                row.innerHTML = `
                    <td>${escapeHtml(card.name)}</td>
                    <td>${escapeHtml(card.set)}</td>
                    <td>${escapeHtml(card.condition)}</td>
                    <td>
                        <input type="number" class="quantity-input" value="${card.quantity}" 
                               onchange="updateCardQuantity('${card.tcgplayerId}', this.value)">
                    </td>
                    <td>$${card.marketPrice.toFixed(2)}</td>
                    <td>$${card.lowPrice.toFixed(2)}</td>
                    <td>$${card.lowWithShipping.toFixed(2)}</td>
                    <td>$${card.originalPrice.toFixed(2)}</td>
                    <td>$${card.calculatedPrice.toFixed(2)}</td>
                `;
                
                tbody.appendChild(row);
            });
        }

        function updateStatistics() {
            const totalCards = pricingService.cards.length;
            const totalValue = pricingService.cards.reduce((sum, card) => sum + (card.calculatedPrice * card.quantity), 0);
            
            document.getElementById('total-cards').textContent = totalCards;
            document.getElementById('total-value').textContent = `$${totalValue.toFixed(2)}`;
        }

        function showImportStatus(message, type) {
            const statusDiv = document.getElementById('import-status');
            statusDiv.textContent = message;
            statusDiv.className = `alert alert-${type}`;
            statusDiv.classList.remove('d-none');
            
            setTimeout(() => {
                statusDiv.classList.add('d-none');
            }, 5000);
        }

        function downloadCSV(content, filename) {
            const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function sortCards(cards) {
            return cards.sort((a, b) => {
                let aVal, bVal;
                
                switch (currentSort.column) {
                    case 'name':
                        aVal = a.name.toLowerCase();
                        bVal = b.name.toLowerCase();
                        break;
                    case 'set':
                        aVal = a.set.toLowerCase();
                        bVal = b.set.toLowerCase();
                        break;
                    case 'condition':
                        aVal = a.condition.toLowerCase();
                        bVal = b.condition.toLowerCase();
                        break;
                    case 'quantity':
                        aVal = a.quantity;
                        bVal = b.quantity;
                        break;
                    case 'marketPrice':
                        aVal = a.marketPrice;
                        bVal = b.marketPrice;
                        break;
                    case 'lowPrice':
                        aVal = a.lowPrice;
                        bVal = b.lowPrice;
                        break;
                    case 'lowShipping':
                        aVal = a.lowWithShipping;
                        bVal = b.lowWithShipping;
                        break;
                    case 'originalPrice':
                        aVal = a.originalPrice;
                        bVal = b.originalPrice;
                        break;
                    case 'calculatedPrice':
                        aVal = a.calculatedPrice;
                        bVal = b.calculatedPrice;
                        break;
                    default:
                        return 0;
                }
                
                if (aVal < bVal) return currentSort.direction === 'asc' ? -1 : 1;
                if (aVal > bVal) return currentSort.direction === 'asc' ? 1 : -1;
                return 0;
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Make functions globally accessible
        window.updateCardQuantity = function(cardId, newQuantity) {
            if (window.pricingService) {
                window.pricingService.updateCardQuantity(cardId, parseInt(newQuantity));
                updateStatistics();
            }
        };

        // Inventory import functions
        function importInventoryFromCSV(csvText) {
            const lines = csvText.split('\n');
            const headers = parseCSVLine(lines[0]);
            
            // Clear existing inventory
            inventory = [];
            
            // Process each line (skip header)
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                
                try {
                    const values = parseCSVLine(lines[i]);
                    if (values.length !== headers.length) continue;
                    
                    const item = {
                        tcgplayerId: values[0].replace(/"/g, ''),
                        productLine: values[1].replace(/"/g, ''),
                        setName: values[2].replace(/"/g, ''),
                        productName: values[3].replace(/"/g, ''),
                        title: values[4].replace(/"/g, ''),
                        number: values[5].replace(/"/g, ''),
                        rarity: values[6].replace(/"/g, ''),
                        condition: values[7].replace(/"/g, ''),
                        tcgMarketPrice: parseFloat(values[8]) || 0,
                        tcgDirectLow: values[9].replace(/"/g, ''),
                        tcgLowWithShipping: parseFloat(values[10]) || 0,
                        tcgLowPrice: parseFloat(values[11]) || 0,
                        totalQuantity: parseInt(values[12]) || 0,
                        addToQuantity: parseInt(values[13]) || 0,
                        tcgMarketplacePrice: parseFloat(values[14]) || 0,
                        photoUrl: values[15].replace(/"/g, ''),
                        
                        // Calculate price based on TCG pricing rules
                        calculatePrice: function() {
                            const marketPrice = this.tcgMarketPrice;
                            const lowPrice = this.tcgLowPrice;
                            const lowWithShipping = this.tcgLowWithShipping;
                            
                            let estimatedPrice;
                            
                            if (marketPrice <= 0.30) {
                                estimatedPrice = Math.max(0.50, lowPrice);
                            } else if (marketPrice > 30) {
                                estimatedPrice = marketPrice;
                            } else {
                                const avgLowAndMarket = (lowWithShipping + marketPrice) / 2;
                                estimatedPrice = Math.max(0.50, Math.max(lowPrice, avgLowAndMarket));
                            }
                            
                            this.estimatedPrice = estimatedPrice;
                            return estimatedPrice;
                        }
                    };
                    
                    // Calculate price for this item
                    item.calculatePrice();
                    
                    inventory.push(item);
                } catch (error) {
                    console.warn(`Error processing inventory line ${i}:`, error);
                }
            }
            
            // Update the inventory table
            updateInventoryTable();
            
            // Update pricing table if we're on the pricing tab
            updatePricingTable();
            updatePricingStatistics();
            
            // Save to localStorage
            try {
                localStorage.setItem('inventory', JSON.stringify(inventory));
            } catch (storageError) {
                console.warn('Could not save inventory to localStorage:', storageError.message);
            }
            
            console.log(`Imported ${inventory.length} inventory items`);
        }

        function updateInventoryTable() {
            const tbody = document.getElementById('card-table-body');
            
            if (inventory.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center">No inventory loaded. Import inventory to get started.</td></tr>';
                return;
            }
            
            // Clear existing rows
            tbody.innerHTML = '';
            
            inventory.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${escapeHtml(item.productName || item.title)}</td>
                    <td>${escapeHtml(item.setName)}</td>
                    <td>${escapeHtml(item.condition)}</td>
                    <td>
                        <input type="number" class="quantity-input" value="${item.totalQuantity}" 
                               onchange="updateInventoryQuantity('${item.tcgplayerId}', this.value)">
                    </td>
                    <td>$${item.tcgMarketPrice.toFixed(2)}</td>
                    <td>$${item.tcgLowPrice.toFixed(2)}</td>
                    <td>$${item.tcgLowWithShipping.toFixed(2)}</td>
                    <td>$${item.tcgMarketplacePrice.toFixed(2)}</td>
                    <td>$${item.estimatedPrice.toFixed(2)}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function showInventoryImportStatus(message, type) {
            const statusDiv = document.getElementById('inventory-import-status');
            statusDiv.textContent = message;
            statusDiv.className = `alert alert-${type}`;
            statusDiv.classList.remove('d-none');
            
            setTimeout(() => {
                statusDiv.classList.add('d-none');
            }, 5000);
        }

        // Pricing tool functions - now just calls the main inventory table update
        function updatePricingTable() {
            updateInventoryTable();
        }

        function updatePricingStatistics() {
            const totalCards = inventory.length;
            const totalValue = inventory.reduce((sum, item) => sum + (item.estimatedPrice * item.totalQuantity), 0);
            const avgPrice = totalCards > 0 ? totalValue / inventory.reduce((sum, item) => sum + item.totalQuantity, 0) : 0;
            
            document.getElementById('total-cards').textContent = totalCards;
            document.getElementById('total-value').textContent = `$${totalValue.toFixed(2)}`;
            document.getElementById('avg-price').textContent = `$${avgPrice.toFixed(2)}`;
        }

        function showPricingStatus(message, type) {
            // Create a temporary status message
            const statusDiv = document.createElement('div');
            statusDiv.className = `alert alert-${type} alert-dismissible fade show`;
            statusDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            // Insert at the top of the pricing panel
            const pricingPanel = document.getElementById('pricing-panel');
            pricingPanel.insertBefore(statusDiv, pricingPanel.firstChild);
            
            setTimeout(() => {
                if (statusDiv.parentNode) {
                    statusDiv.remove();
                }
            }, 5000);
        }

        function exportInventoryToCSV() {
            if (inventory.length === 0) {
                throw new Error('No inventory to export');
            }
            
            const headers = [
                'TCGplayer Id', 'Product Line', 'Set Name', 'Product Name', 'Title', 'Number', 
                'Rarity', 'Condition', 'TCG Market Price', 'TCG Direct Low', 'TCG Low Price With Shipping', 
                'TCG Low Price', 'Total Quantity', 'Add to Quantity', 'TCG Marketplace Price', 'Photo URL'
            ];
            
            let csvContent = headers.join(',') + '\n';
            
            inventory.forEach(item => {
                const row = [
                    escapeCSV(item.tcgplayerId || ''),
                    escapeCSV(item.productLine || ''),
                    escapeCSV(item.setName || ''),
                    escapeCSV(item.productName || ''),
                    escapeCSV(item.title || ''),
                    escapeCSV(item.number || ''),
                    escapeCSV(item.rarity || ''),
                    escapeCSV(item.condition || ''),
                    escapeCSV(item.tcgMarketPrice === 0 ? '' : item.tcgMarketPrice),
                    escapeCSV(item.tcgDirectLow || ''),
                    escapeCSV(item.tcgLowWithShipping === 0 ? '' : item.tcgLowWithShipping),
                    escapeCSV(item.tcgLowPrice === 0 ? '' : item.tcgLowPrice),
                    escapeCSV(item.totalQuantity || ''),
                    escapeCSV(item.addToQuantity || ''),
                    escapeCSV(item.estimatedPrice === 0 ? '' : item.estimatedPrice),
                    escapeCSV(item.photoUrl || '')
                ];
                
                csvContent += row.join(',') + '\n';
            });
            
            return csvContent;
        }

        function updateInventoryQuantity(cardId, newQuantity) {
            const item = inventory.find(i => i.tcgplayerId === cardId);
            if (item) {
                item.totalQuantity = parseInt(newQuantity) || 0;
                updatePricingStatistics();
                
                // Save to localStorage
                try {
                    localStorage.setItem('inventory', JSON.stringify(inventory));
                } catch (storageError) {
                    console.warn('Could not save inventory to localStorage:', storageError.message);
                }
            }
        }

        // Make functions globally accessible
        window.updateInventoryQuantity = updateInventoryQuantity;

        // Override displayCardDetails to use price list
        window.displayCardDetails = function(card) {
            selectedCard = card;
            const container = document.getElementById('card-details-container');
            
            if (!card) {
                container.innerHTML = '<p class="text-center">Select a card to view details</p>';
                return;
            }
            
            // Find matching card in price list
            let priceInfo = null;
            if (priceList && priceList.length > 0) {
                priceInfo = priceList.find(p => 
                    p.productName.toLowerCase().includes(card.name.toLowerCase()) ||
                    p.title.toLowerCase().includes(card.name.toLowerCase())
                );
            }
            
            let priceDisplay = '';
            if (priceInfo) {
                const calculatedPrice = priceInfo.calculatePrice();
                priceDisplay = `
                    <div class="price-info">
                        <h5>Pricing Information</h5>
                        <table>
                            <tr><td>TCG Market Price:</td><td>$${priceInfo.tcgMarketPrice.toFixed(2)}</td></tr>
                            <tr><td>TCG Low Price:</td><td>$${priceInfo.tcgLowPrice.toFixed(2)}</td></tr>
                            <tr><td>TCG Low w/ Shipping:</td><td>$${priceInfo.tcgLowWithShipping.toFixed(2)}</td></tr>
                            <tr><td class="estimated-price">Calculated Price:</td><td class="estimated-price">$${calculatedPrice.toFixed(2)}</td></tr>
                        </table>
                    </div>
                `;
            }
            
            container.innerHTML = `
                <div class="text-center mb-3">
                    <img src="${card.image_uris?.normal || card.image_uris?.large || ''}" 
                         alt="${card.name}" class="card-image" style="max-width: 200px;">
                </div>
                <h4>${card.name}</h4>
                <p><strong>Set:</strong> ${card.set_name}</p>
                <p><strong>Rarity:</strong> ${card.rarity}</p>
                <p><strong>Type:</strong> ${card.type_line}</p>
                ${priceDisplay}
                <div class="mt-3">
                    <button class="btn btn-primary btn-sm" onclick="addToInventory('${card.id}')">
                        Add to Inventory
                    </button>
                </div>
            `;
        };
    </script>
</body>
</html>
