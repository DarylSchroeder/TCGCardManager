<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TCG Card Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="js/navbar.js"></script>
    <script src="js/errorHandler.js"></script>
    <style>
        .card-image {
            width: 100%;
            height: auto;
            cursor: pointer;
        }
        .card-container {
            margin-bottom: 20px;
        }
        #loading {
            display: none;
        }
        #error-message {
            display: none;
        }
        .selected-card {
            border: 3px solid #007bff;
            background-color: #e6f2ff;
        }
        #inventory-table {
            margin-top: 0;
        }
        .card-list-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
            transition: background-color 0.2s;
            cursor: pointer;
        }
        .card-list-item:hover {
            background-color: #f0f7ff;
        }
        .card-thumbnail {
            width: 60px;
            height: 84px;
            object-fit: cover;
            margin-right: 15px;
        }
        .card-info {
            flex-grow: 1;
        }
        .card-actions {
            min-width: 100px;
            text-align: right;
        }
        .search-and-details-row {
            height: 500px;
            margin-bottom: 20px;
            overflow: hidden; /* Prevent content from flowing outside */
        }
        .search-results-container {
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 0.25rem;
        }
        #card-details-container {
            height: 450px;
            overflow-y: auto;
            margin-bottom: 1rem;
        }
        .sticky-top-custom {
            position: sticky;
            top: 20px;
        }
        #search-results {
            overflow-y: auto;
            max-height: 350px; /* Explicit height to ensure scrolling works */
            flex: 1;
        }
        .price-info {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
        }
        .price-info h5 {
            margin-bottom: 10px;
            color: #0d6efd;
        }
        .price-info table {
            width: 100%;
        }
        .price-info td {
            padding: 3px 0;
        }
        .price-info td:first-child {
            font-weight: bold;
            width: 60%;
        }
        .price-info td:last-child {
            text-align: right;
        }
        .price-info .estimated-price {
            font-size: 1.1em;
            font-weight: bold;
            color: #198754;
        }
        .price-list-status {
            font-size: 0.9em;
            margin-top: 5px;
        }
        .price-list-loaded {
            color: #198754;
        }
        .price-list-error {
            color: #dc3545;
        }
    </style>
</head>
<body>
    <div class="container-fluid mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>TCG Card Manager</h1>
            <div class="d-flex align-items-center">
                <div id="price-list-status" class="price-list-status me-2">Loading price list...</div>
                <button id="update-price-list" class="btn btn-outline-secondary btn-sm">Update Price List</button>
            </div>
        </div>
        
        <div class="row search-and-details-row">
            <!-- Left Column: Card Search (60%) -->
            <div class="col-md-7">
                <div class="card h-100">
                    <div class="card-header">
                        <h3>Card Search</h3>
                    </div>
                    <div class="card-body" style="overflow: hidden; display: flex; flex-direction: column; height: 430px;">
                        <div class="input-group mb-3">
                            <input type="text" id="search-input" class="form-control" placeholder="Enter card name...">
                            <button id="search-button" class="btn btn-primary">Search</button>
                        </div>
                        
                        <div id="loading" class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Searching for cards...</p>
                        </div>
                        
                        <div id="error-message" class="alert alert-danger"></div>
                        
                        <div id="search-results" class="search-results-container">
                            <p class="text-center p-3">Enter a card name to search</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Right Column: Card Details (40%) -->
            <div class="col-md-5">
                <div class="card h-100">
                    <div class="card-header bg-primary text-white">
                        <h3>Card Details</h3>
                    </div>
                    <div class="card-body" id="card-details-container">
                        <p class="text-center">Select a card to view details</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h3>Inventory</h3>
                <button id="export-button" class="btn btn-secondary">Export to CSV</button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table id="inventory-table" class="table table-striped">
                        <thead>
                            <tr>
                                <th>Card Name</th>
                                <th>Set</th>
                                <th>Condition</th>
                                <th>Quantity</th>
                                <th>Price</th>
                                <th>Total</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="inventory-body">
                            <tr id="empty-inventory-row">
                                <td colspan="7" class="text-center">No cards in inventory</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="js/tcgPricing.js"></script>
    <script>
        // Global variables
        let selectedCard = null;
        const inventory = [];
        let pricingService = new TCGPricingService();
        let priceList = [];
        
        // DOM Elements
        const searchInput = document.getElementById('search-input');
        const searchButton = document.getElementById('search-button');
        const searchResults = document.getElementById('search-results');
        const cardDetailsContainer = document.getElementById('card-details-container');
        const loadingIndicator = document.getElementById('loading');
        const errorMessage = document.getElementById('error-message');
        const inventoryBody = document.getElementById('inventory-body');
        const exportButton = document.getElementById('export-button');
        const priceListStatus = document.getElementById('price-list-status');
        
        // Load the price list when the page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadPriceList();
        });
        
        // Function to load the price list
        function loadPriceList() {
            // First try to load from localStorage if available
            try {
                const savedPriceList = localStorage.getItem('priceListCSV');
                
                if (savedPriceList) {
                    priceList = parsePriceListCSV(savedPriceList);
                    priceListStatus.textContent = `Price list loaded from local storage: ${priceList.length} cards`;
                    priceListStatus.className = 'price-list-status price-list-loaded';
                    console.log(`Loaded ${priceList.length} cards from local storage`);
                    return;
                }
            } catch (error) {
                console.error('Error accessing localStorage:', error);
                // Continue to fetch from server if local storage access fails
            }
            
            // If no saved list or access failed, fetch from server
            fetch('/Full_price_list_nm_lp.csv')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to load price list');
                    }
                    return response.text();
                })
                .then(csvText => {
                    try {
                        priceList = parsePriceListCSV(csvText);
                        priceListStatus.textContent = `Price list loaded: ${priceList.length} cards`;
                        priceListStatus.className = 'price-list-status price-list-loaded';
                        console.log(`Loaded ${priceList.length} cards from price list`);
                        
                        // Try to save to localStorage but don't fail if it exceeds quota
                        try {
                            localStorage.setItem('priceListCSV', csvText);
                        } catch (storageError) {
                            console.warn('Could not save price list to localStorage:', storageError.message);
                        }
                    } catch (error) {
                        throw new Error('Error parsing price list: ' + error.message);
                    }
                })
                .catch(error => {
                    priceListStatus.textContent = `Error: ${error.message}`;
                    priceListStatus.className = 'price-list-status price-list-error';
                    console.error('Error loading price list:', error);
                });
        }
        
        // Function to parse the price list CSV
        function parsePriceListCSV(csvText) {
            const lines = csvText.split('\\n');
            const headers = lines[0].split(',');
            
            const cards = [];
            
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                
                const values = parseCSVLine(lines[i]);
                if (values.length !== headers.length) continue;
                
                const card = {
                    tcgplayerId: values[0].replace(/"/g, ''),
                    productLine: values[1].replace(/"/g, ''),
                    setName: values[2].replace(/"/g, ''),
                    productName: values[3].replace(/"/g, ''),
                    title: values[4].replace(/"/g, ''),
                    number: values[5].replace(/"/g, ''),
                    rarity: values[6].replace(/"/g, ''),
                    condition: values[7].replace(/"/g, ''),
                    tcgMarketPrice: parseFloat(values[8]) || 0,
                    tcgDirectLow: values[9].replace(/"/g, ''),
                    tcgLowWithShipping: parseFloat(values[10]) || 0,
                    tcgLowPrice: parseFloat(values[11]) || 0,
                    totalQuantity: values[12].replace(/"/g, ''),
                    addToQuantity: values[13].replace(/"/g, ''),
                    tcgMarketplacePrice: values[14].replace(/"/g, ''),
                    photoUrl: values[15].replace(/"/g, ''),
                    
                    // Add a method to calculate the price based on TCG pricing rules
                    calculatePrice: function() {
                        const marketPrice = this.tcgMarketPrice;
                        const lowPrice = this.tcgLowPrice;
                        const lowWithShipping = this.tcgLowWithShipping;
                        
                        let estimatedPrice;
                        
                        if (marketPrice <= 0.30) {
                            // Cheap cards
                            estimatedPrice = Math.max(0.50, lowPrice);
                        } else if (marketPrice > 30) {
                            // Expensive cards
                            estimatedPrice = marketPrice;
                        } else {
                            // Standard cards
                            const avgLowAndMarket = (lowWithShipping + marketPrice) / 2;
                            estimatedPrice = Math.max(0.50, Math.max(lowPrice, avgLowAndMarket));
                        }
                        
                        this.estimatedPrice = estimatedPrice;
                        return estimatedPrice;
                    }
                };
                
                cards.push(card);
            }
            
            return cards;
        }
        
        // Helper function to parse CSV lines correctly (handling quoted values and escaped quotes)
        function parseCSVLine(line) {
            const fields = [];
            let inQuotes = false;
            let currentField = '';
            
            for (let i = 0; i < line.length; i++) {
                const c = line[i];
                
                if (c === '"') {
                    if (inQuotes && i + 1 < line.length && line[i + 1] === '"') {
                        // Escaped quote (double quote within quoted field)
                        currentField += '"';
                        i++; // Skip next quote
                    } else {
                        // Toggle quote state
                        inQuotes = !inQuotes;
                    }
                } else if (c === ',' && !inQuotes) {
                    // Field separator
                    fields.push(currentField);
                    currentField = '';
                } else {
                    currentField += c;
                }
            }
            
            // Add last field
            fields.push(currentField);
            return fields;
        }
        
        // Set name mapping between Scryfall and price list
        const setNameMapping = {
            // Modern sets
            "modern horizons 3": ["Modern Horizons 3"],
            "mh3": ["Modern Horizons 3"],
            "commander legends: battle for baldur's gate": ["Commander Legends: Battle for Baldur's Gate"],
            "clb": ["Commander Legends: Battle for Baldur's Gate"],
            "streets of new capenna": ["Streets of New Capenna"],
            "snc": ["Streets of New Capenna"],
            "kamigawa: neon dynasty": ["Kamigawa: Neon Dynasty"],
            "neo": ["Kamigawa: Neon Dynasty"],
            "innistrad: crimson vow": ["Innistrad: Crimson Vow"],
            "vow": ["Innistrad: Crimson Vow"],
            "innistrad: midnight hunt": ["Innistrad: Midnight Hunt"],
            "mid": ["Innistrad: Midnight Hunt"],
            "adventures in the forgotten realms": ["Adventures in the Forgotten Realms"],
            "afr": ["Adventures in the Forgotten Realms"],
            "strixhaven: school of mages": ["Strixhaven"],
            "stx": ["Strixhaven"],
            "kaldheim": ["Kaldheim"],
            "khm": ["Kaldheim"],
            "zendikar rising": ["Zendikar Rising"],
            "znr": ["Zendikar Rising"],
            "ikoria: lair of behemoths": ["Ikoria"],
            "iko": ["Ikoria"],
            "theros beyond death": ["Theros Beyond Death"],
            "thb": ["Theros Beyond Death"],
            "throne of eldraine": ["Throne of Eldraine"],
            "eld": ["Throne of Eldraine"],
            "war of the spark": ["War of the Spark"],
            "war": ["War of the Spark"],
            "ravnica allegiance": ["Ravnica Allegiance"],
            "rna": ["Ravnica Allegiance"],
            "guilds of ravnica": ["Guilds of Ravnica"],
            "grn": ["Guilds of Ravnica"],
            "dominaria": ["Dominaria"],
            "dom": ["Dominaria"],
            
            // Core sets
            "core set 2021": ["Core Set 2021"],
            "m21": ["Core Set 2021"],
            "core set 2020": ["Core Set 2020"],
            "m20": ["Core Set 2020"],
            "core set 2019": ["Core Set 2019"],
            "m19": ["Core Set 2019"],
            
            // Special sets
            "the list": ["The List Reprints"],
            "plst": ["The List Reprints"],
            "time spiral remastered": ["Time Spiral Remastered"],
            "tsr": ["Time Spiral Remastered"],
            "double masters": ["Double Masters"],
            "2xm": ["Double Masters"],
            "double masters 2022": ["Double Masters 2022"],
            "2x2": ["Double Masters 2022"],
            "jumpstart": ["Jumpstart"],
            "jmp": ["Jumpstart"],
            "commander legends": ["Commander Legends"],
            "cmr": ["Commander Legends"],
            
            // Commander sets
            "commander 2021": ["Commander 2021"],
            "c21": ["Commander 2021"],
            "commander 2020": ["Commander 2020"],
            "c20": ["Commander 2020"],
            "commander 2019": ["Commander 2019"],
            "c19": ["Commander 2019"],
            "commander 2018": ["Commander 2018"],
            "c18": ["Commander 2018"],
            
            // Older sets
            "urza's saga": ["Urza's Saga"],
            "usg": ["Urza's Saga"],
            "world championship decks": ["World Championship Decks"],
            "fnm promos": ["FNM Promos"],
            "commander 2014": ["Commander 2014"],
            "c14": ["Commander 2014"],
            "commander anthology": ["Commander Anthology"],
            "cma": ["Commander Anthology"]
        };
        
        // Function to find a card in the price list
        function findCardInPriceList(cardName, setName) {
            console.log(`Searching for "${cardName}" in set "${setName}"`);
            
            // Try to find an exact match first by name only
            let matches = priceList.filter(card => 
                card.productName.toLowerCase() === cardName.toLowerCase()
            );
            
            console.log(`Found ${matches.length} name matches`);
            
            // If we have multiple matches and a set name, try to filter by set
            if (matches.length > 0 && setName) {
                const setMatches = matches.filter(card => {
                    const priceListSetName = card.setName.toLowerCase();
                    const searchSetName = setName.toLowerCase();
                    
                    // Direct match
                    if (priceListSetName === searchSetName) {
                        return true;
                    }
                    // Check if the set name is in our mapping
                    else if (setNameMapping[searchSetName] && 
                             setNameMapping[searchSetName].some(mappedName => 
                                mappedName.toLowerCase() === priceListSetName)) {
                        return true;
                    }
                    // Handle abbreviations (e.g., "mh3" vs "Modern Horizons 3")
                    else if (searchSetName.includes(priceListSetName) || priceListSetName.includes(searchSetName)) {
                        return true;
                    }
                    // Special case for "The List Reprints" which might be labeled differently
                    else if (searchSetName.includes("list") && priceListSetName.includes("list")) {
                        return true;
                    }
                    return false;
                });
                
                // If we found set matches, use those
                if (setMatches.length > 0) {
                    matches = setMatches;
                    console.log(`Filtered to ${matches.length} set matches`);
                }
            }
            
            // If no exact match, try a partial match on the card name
            if (matches.length === 0) {
                matches = priceList.filter(card => 
                    card.productName.toLowerCase().includes(cardName.toLowerCase())
                );
                console.log(`Found ${matches.length} partial matches`);
            }
            
            return matches;
        }
        
        // Debouncing for search input
        let searchTimeout;
        
        // Event Listeners
        searchButton.addEventListener('click', searchCards);
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                clearTimeout(searchTimeout);
                searchCards();
            }
        });
        
        // Add debounced search on input
        searchInput.addEventListener('input', function(e) {
            clearTimeout(searchTimeout);
            const query = e.target.value.trim();
            
            if (query.length >= 2) {
                searchTimeout = setTimeout(() => {
                    searchCards();
                }, 300); // 300ms debounce
            }
        });
        
        exportButton.addEventListener('click', exportInventory);
        
        // Functions
        function searchCards() {
            const query = searchInput.value.trim();
            if (query === '') {
                showError('Please enter a card name');
                return;
            }
            
            // Enhanced loading state
            showLoading();
            hideError();
            searchButton.disabled = true;
            searchButton.textContent = 'Searching...';
            
            // First search for cards by name
            fetch(`https://api.scryfall.com/cards/search?q=${encodeURIComponent(query)}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('No cards found');
                    }
                    return response.json();
                })
                .then(data => {
                    // If we only got one result and it has an oracle_id, fetch all printings
                    if (data.data.length === 1 && data.data[0].oracle_id) {
                        return fetch(`https://api.scryfall.com/cards/search?order=released&q=oracleid%3A${data.data[0].oracle_id}&unique=prints`)
                            .then(response => {
                                if (!response.ok) {
                                    // If this fails, just use the original results
                                    return data;
                                }
                                return response.json();
                            });
                    }
                    return data;
                })
                .then(data => {
                    displaySearchResults(data.data);
                    hideLoading();
                    // Reset button state
                    searchButton.disabled = false;
                    searchButton.textContent = 'Search';
                })
                .catch(error => {
                    hideLoading();
                    showError(error.message);
                    // Reset button state
                    searchButton.disabled = false;
                    searchButton.textContent = 'Search';
                    // Safe DOM manipulation instead of innerHTML
                    searchResults.textContent = '';
                    const noResultsMsg = document.createElement('p');
                    noResultsMsg.className = 'text-center p-3';
                    noResultsMsg.textContent = 'No cards found';
                    searchResults.appendChild(noResultsMsg);
                });
        }
        
        function displaySearchResults(cards) {
            // Clear results safely
            searchResults.textContent = '';
            
            cards.forEach(card => {
                const cardElement = document.createElement('div');
                cardElement.className = 'card-list-item';
                cardElement.dataset.cardId = card.id;
                
                // Get the card image URL
                let imageUrl = '';
                if (card.image_uris && card.image_uris.small) {
                    imageUrl = card.image_uris.small;
                } else if (card.card_faces && card.card_faces[0].image_uris) {
                    imageUrl = card.card_faces[0].image_uris.small;
                }
                
                // Get the set name
                const setName = card.set_name || '';
                
                cardElement.innerHTML = `
                    <img src="${imageUrl}" alt="${card.name}" class="card-thumbnail">
                    <div class="card-info">
                        <div class="fw-bold">${card.name}</div>
                        <div class="text-muted small">${setName} (${card.set.toUpperCase()}) • ${card.rarity}</div>
                    </div>
                `;
                
                cardElement.addEventListener('click', () => {
                    // Remove selected class from all cards
                    document.querySelectorAll('.card-list-item').forEach(el => {
                        el.classList.remove('selected-card');
                    });
                    
                    // Add selected class to this card
                    cardElement.classList.add('selected-card');
                    
                    // Display card details
                    displayCardDetails(card);
                    
                    // Store selected card
                    selectedCard = card;
                });
                
                searchResults.appendChild(cardElement);
            });
        }
        
        function displayCardDetails(card) {
            console.log("Displaying card details:", card);
            
            // Get the card image URL
            let imageUrl = '';
            if (card.image_uris && card.image_uris.normal) {
                imageUrl = card.image_uris.normal;
            } else if (card.card_faces && card.card_faces[0].image_uris) {
                imageUrl = card.card_faces[0].image_uris.normal;
            }
            
            // Find pricing information from our price list
            const priceMatches = findCardInPriceList(card.name, card.set_name);
            console.log("Price matches:", priceMatches);
            
            let priceInfoHtml = '';
            let suggestedPrice = 0;
            
            if (priceMatches.length > 0) {
                // Sort by condition: Near Mint first, then Lightly Played
                priceMatches.sort((a, b) => {
                    if (a.condition.includes('Near Mint') && !b.condition.includes('Near Mint')) return -1;
                    if (!a.condition.includes('Near Mint') && b.condition.includes('Near Mint')) return 1;
                    return 0;
                });
                
                // Get the first match (Near Mint if available)
                const priceInfo = priceMatches[0];
                
                // Calculate the estimated price
                priceInfo.calculatePrice();
                suggestedPrice = priceInfo.estimatedPrice;
                
                priceInfoHtml = `
                    <div class="price-info">
                        <h5>Pricing Information (${priceInfo.condition})</h5>
                        <table>
                            <tr>
                                <td>TCG Market Price:</td>
                                <td>$${priceInfo.tcgMarketPrice.toFixed(2)}</td>
                            </tr>
                            <tr>
                                <td>TCG Low Price:</td>
                                <td>$${priceInfo.tcgLowPrice.toFixed(2)}</td>
                            </tr>
                            <tr>
                                <td>TCG Low With Shipping:</td>
                                <td>$${priceInfo.tcgLowWithShipping.toFixed(2)}</td>
                            </tr>
                            <tr class="estimated-price">
                                <td>Estimated Price:</td>
                                <td>$${priceInfo.estimatedPrice.toFixed(2)}</td>
                            </tr>
                        </table>
                    </div>
                `;
            } else {
                priceInfoHtml = `
                    <div class="price-info alert alert-warning">
                        <h5>No pricing information available</h5>
                        <p>This card was not found in the price list.</p>
                    </div>
                `;
            }
            
            cardDetailsContainer.innerHTML = `
                <div class="text-center mb-3">
                    <img src="${imageUrl}" alt="${card.name}" class="img-fluid" style="max-height: 300px;">
                </div>
                <h4>${card.name}</h4>
                <p class="text-muted">${card.set_name} (${card.set.toUpperCase()}) • ${card.rarity}</p>
                ${priceInfoHtml}
                <div class="mt-3">
                    <form id="add-to-inventory-form">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label for="quantity" class="form-label">Quantity</label>
                                <input type="number" class="form-control" id="quantity" min="1" value="1">
                            </div>
                            <div class="col-md-4">
                                <label for="condition" class="form-label">Condition</label>
                                <select class="form-select" id="condition">
                                    <option value="Near Mint">Near Mint</option>
                                    <option value="Lightly Played">Lightly Played</option>
                                    <option value="Moderately Played">Moderately Played</option>
                                    <option value="Heavily Played">Heavily Played</option>
                                    <option value="Damaged">Damaged</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="price" class="form-label">Price</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" class="form-control" id="price" min="0" step="0.01" 
                                           value="${suggestedPrice > 0 ? suggestedPrice.toFixed(2) : '0.00'}">
                                </div>
                            </div>
                        </div>
                        <div class="d-grid mt-3">
                            <button type="button" class="btn btn-primary" id="add-to-inventory-btn">Add to Inventory</button>
                        </div>
                    </form>
                </div>
            `;
            
            // Add event listener to the Add to Inventory button
            document.getElementById('add-to-inventory-btn').addEventListener('click', addToInventory);
            
            // Scroll to the top of the details container
            cardDetailsContainer.scrollTop = 0;
        }
        
        function addToInventory() {
            if (!selectedCard) {
                return;
            }
            
            // Input validation with bounds checking
            let quantity = parseInt(document.getElementById('quantity').value) || 1;
            let price = parseFloat(document.getElementById('price').value) || 0;
            const condition = document.getElementById('condition').value;
            
            // Validate quantity bounds (1 to 9999)
            if (quantity < 1) {
                quantity = 1;
                document.getElementById('quantity').value = 1;
            } else if (quantity > 9999) {
                quantity = 9999;
                document.getElementById('quantity').value = 9999;
            }
            
            // Validate price bounds (0 to 99999.99)
            if (price < 0) {
                price = 0;
                document.getElementById('price').value = '0.00';
            } else if (price > 99999.99) {
                price = 99999.99;
                document.getElementById('price').value = '99999.99';
            }
            
            // Create inventory item
            const inventoryItem = {
                id: Date.now(), // Use timestamp as unique ID
                card: selectedCard,
                quantity: quantity,
                condition: condition,
                price: price,
                total: quantity * price
            };
            
            // Add to inventory array
            inventory.push(inventoryItem);
            
            // Update inventory table
            updateInventoryTable();
            
            // Show success message
            alert(`Added ${quantity} ${selectedCard.name} to inventory`);
        }
        
        function updateInventoryTable() {
            // Remove empty inventory row if it exists
            const emptyRow = document.getElementById('empty-inventory-row');
            if (emptyRow) {
                emptyRow.remove();
            }
            
            // Clear existing rows except the empty row
            const rows = inventoryBody.querySelectorAll('tr:not(#empty-inventory-row)');
            rows.forEach(row => row.remove());
            
            // Add inventory items
            inventory.forEach(item => {
                const row = document.createElement('tr');
                row.dataset.id = item.id;
                
                // Get the card image URL
                let imageUrl = '';
                if (item.card.image_uris && item.card.image_uris.small) {
                    imageUrl = item.card.image_uris.small;
                } else if (item.card.card_faces && item.card.card_faces[0].image_uris) {
                    imageUrl = item.card.card_faces[0].image_uris.small;
                }
                
                row.innerHTML = `
                    <td>
                        <div class="d-flex align-items-center">
                            <img src="${imageUrl}" alt="${item.card.name}" class="me-2" style="width: 30px; height: 42px; object-fit: cover;">
                            ${item.card.name}
                        </div>
                    </td>
                    <td>${item.card.set_name}</td>
                    <td>${item.condition}</td>
                    <td>${item.quantity}</td>
                    <td>$${item.price.toFixed(2)}</td>
                    <td>$${item.total.toFixed(2)}</td>
                    <td>
                        <button class="btn btn-sm btn-danger remove-btn" data-id="${item.id}">Remove</button>
                    </td>
                `;
                
                inventoryBody.appendChild(row);
            });
            
            // Add event listeners to remove buttons
            document.querySelectorAll('.remove-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const id = parseInt(this.dataset.id);
                    removeFromInventory(id);
                });
            });
            
            // If inventory is empty, show empty message
            if (inventory.length === 0) {
                inventoryBody.innerHTML = `
                    <tr id="empty-inventory-row">
                        <td colspan="7" class="text-center">No cards in inventory</td>
                    </tr>
                `;
            }
        }
        
        function removeFromInventory(id) {
            const index = inventory.findIndex(item => item.id === id);
            if (index !== -1) {
                inventory.splice(index, 1);
                updateInventoryTable();
            }
        }
        
        function exportInventory() {
            if (inventory.length === 0) {
                alert('Inventory is empty');
                return;
            }
            
            // Create CSV content with TCGplayer format
            const headers = [
                'TCGplayer Id',
                'Product Line',
                'Set Name',
                'Product Name',
                'Title',
                'Number',
                'Rarity',
                'Condition',
                'TCG Market Price',
                'TCG Direct Low',
                'TCG Low Price With Shipping',
                'TCG Low Price',
                'Total Quantity',
                'Add to Quantity',
                'TCG Marketplace Price',
                'Photo URL'
            ];
            
            let csvContent = headers.join(',') + '\n';
            
            inventory.forEach(item => {
                const card = item.card;
                
                // Helper function to properly escape CSV values
                const escapeCSV = (value) => {
                    // Handle NULL, undefined, or empty values as truly empty fields
                    if (value === null || value === undefined || value === '') {
                        return '';  // Return empty field instead of quoted empty string
                    }
                    const str = String(value);
                    // Always quote non-empty strings to ensure proper CSV formatting
                    return '"' + str.replace(/"/g, '""') + '"';
                };
                
                const row = [
                    escapeCSV(card.tcgplayer_id || ''),
                    escapeCSV('Magic'),
                    escapeCSV(card.set_name || ''),
                    escapeCSV(card.name || ''),
                    escapeCSV(''),
                    escapeCSV(card.collector_number || ''),
                    escapeCSV(card.rarity ? card.rarity.charAt(0).toUpperCase() : ''),
                    escapeCSV(item.condition || 'Near Mint'),
                    escapeCSV(card.prices?.usd || '0'),
                    escapeCSV('0'),
                    escapeCSV(card.prices?.usd || '0'),
                    escapeCSV(card.prices?.usd || '0'),
                    escapeCSV(item.quantity || '1'),
                    escapeCSV('0'),
                    escapeCSV(item.price?.toFixed(2) || '0'),
                    escapeCSV(card.image_uris?.normal || card.image_uris?.large || '')
                ];
                
                csvContent += row.join(',') + '\n';
            });
            
            // Create download link
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', 'tcg_inventory.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        function showLoading() {
            loadingIndicator.style.display = 'block';
        }
        
        function hideLoading() {
            loadingIndicator.style.display = 'none';
        }
        
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
        }
        
        function hideError() {
            errorMessage.style.display = 'none';
        }
        
        // Update price list button
        document.getElementById('update-price-list').addEventListener('click', function() {
            // Create a file input element
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.csv';
            
            // When a file is selected
            fileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const csvText = e.target.result;
                    try {
                        priceList = parsePriceListCSV(csvText);
                        priceListStatus.textContent = `Price list updated: ${priceList.length} cards`;
                        priceListStatus.className = 'price-list-status price-list-loaded';
                        console.log(`Updated price list with ${priceList.length} cards`);
                        
                        // If a card is currently selected, update its price information
                        if (selectedCard) {
                            displayCardDetails(selectedCard);
                        }
                        
                        // Try to save to localStorage but don't fail if it exceeds quota
                        try {
                            localStorage.setItem('priceListCSV', csvText);
                        } catch (storageError) {
                            console.warn('Could not save price list to localStorage (likely exceeded quota):', storageError.message);
                            priceListStatus.textContent = `Price list updated: ${priceList.length} cards (not saved to local storage - file too large)`;
                        }
                    } catch (error) {
                        priceListStatus.textContent = `Error: ${error.message}`;
                        priceListStatus.className = 'price-list-status price-list-error';
                        console.error('Error parsing price list:', error);
                    }
                };
                reader.readAsText(file);
            });
            
            // Trigger the file input click
            fileInput.click();
        });
    </script>
</body>
</html>
